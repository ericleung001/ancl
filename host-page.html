<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>ç®¡ç†æˆ‘å˜…å³¶</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body{font-family:'Nunito',sans-serif;background:#F5F5E8;color:#8B5A2B;padding:20px}
        .box{max-width:600px;margin:0 auto;background:white;padding:30px;border-radius:15px;border:2px solid #96C8A4}
        input,textarea,select{width:100%;padding:12px;margin:5px 0 15px 0;border:2px solid #ddd;border-radius:10px;box-sizing:border-box;font-family:inherit;font-size:1rem}
        label{font-weight:bold;color:#4A7A5C}
        .btn{width:100%;padding:15px;border:none;border-radius:10px;cursor:pointer;color:white;font-size:1.2rem}
        .green{background:#96C8A4} .red{background:#d9534f} .blue{background:#73a0c0}
    </style>
</head>
<body>
    <div style="text-align:center;margin-bottom:20px">
        <h1>âœˆï¸ ç®¡ç†æˆ‘å˜…å³¶</h1>
        <a href="index.html" style="text-decoration:none;color:#73a0c0;font-weight:bold">â† è¿”é¦–é </a>
    </div>
    <div class="box" id="content">æª¢æŸ¥ä¸­...</div>

    <script>
        const API_URL = "https://api.ttctv-105.cc";
        const user = JSON.parse(localStorage.getItem('acnh_user'));
        if(!user) window.location.href="login.html";

        const content = document.getElementById('content');
        checkStatus();

        async function checkStatus() {
            try {
                const res = await fetch(`${API_URL}/my-status?email=${encodeURIComponent(user.email)}`);
                const json = await res.json();
                if(json.data) showClose(json.data); else showHost();
            } catch(e) { content.innerHTML = "é€£ç·šå¤±æ•—"; }
        }

        function showHost() {
            content.innerHTML = `
                <h3>ç™»è¨˜é–‹å³¶</h3>
                <label>Dodo Codeâ„¢</label>
                <input id="dodo" placeholder="5ä½ Code" maxlength="5">
                <label>å³¶å</label>
                <input id="name" value="${user.username}çš„å³¶">
                <label>åŒæ™‚ä¸Šå³¶äººæ•¸é™åˆ¶</label>
                <select id="maxUsers">
                    <option value="2">2äºº</option>
                    <option value="3">3äºº</option>
                    <option value="4" selected>4äºº</option>
                    <option value="5">5äºº</option>
                    <option value="6">6äºº</option>
                    <option value="7">7äºº</option>
                    <option value="8">8äºº</option>
                </select>
                <label style="color:#e67e22">âš ï¸ é€²å³¶æ³¨æ„äº‹é … (é¡¯ç¤ºåœ¨æ’éšŠå€)</label>
                <textarea id="notice" placeholder="ä¾‹å¦‚: åªé™æ©Ÿå ´é›¢é–‹ã€ç¦ç©¿æ½›æ°´è¡£..."></textarea>
                <label>å‚™è¨» (é¡¯ç¤ºåœ¨åˆ—è¡¨)</label>
                <textarea id="note" placeholder="ä¾‹å¦‚: è³£å¤§é ­èœ 500ï¼"></textarea>
                <button onclick="host()" class="btn green">ç¢ºèªé–‹å³¶</button>
            `;
        }

        function showClose(data) {
            content.innerHTML = `
                <h3 style="text-align:center;color:#4A7A5C">é–‹æ”¾ä¸­...</h3>
                <p>å³¶å: ${data.island_name}</p>
                <p>é™åˆ¶äººæ•¸: ${data.max_visitors} äºº</p>
                <p style="font-size:1.5rem;color:#73a0c0;font-weight:bold;text-align:center">${data.dodo_code}</p>
                <a href="island.html?host=${encodeURIComponent(user.email)}" class="btn blue" style="display:block;text-align:center;text-decoration:none;box-sizing:border-box;margin-bottom:10px">ğŸ‘ï¸ æª¢è¦–æ’éšŠ</a>
                <button onclick="closeIsland()" class="btn red">âš ï¸ ç«‹å³é—œå³¶</button>
            `;
        }

        async function host() {
            const payload = {
                email: user.email, 
                islandName: document.getElementById('name').value,
                dodoCode: document.getElementById('dodo').value, 
                note: document.getElementById('note').value,
                maxVisitors: document.getElementById('maxUsers').value,
                notice: document.getElementById('notice').value
            };
            await fetch(`${API_URL}/host`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
            checkStatus();
        }

        async function closeIsland() {
            if(!confirm("ç¢ºå®šé—œå³¶ï¼Ÿ")) return;
            await fetch(`${API_URL}/close`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({email: user.email}) });
            checkStatus();
        }
    </script>
</body>
</html>
