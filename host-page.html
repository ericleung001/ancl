<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>管理我嘅島</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body{font-family:'Nunito',sans-serif;background:#F5F5E8;color:#8B5A2B;padding:20px}
        .box{max-width:600px;margin:0 auto;background:white;padding:30px;border-radius:15px;border:2px solid #96C8A4}
        input,textarea,select{width:100%;padding:12px;margin:5px 0 15px 0;border:2px solid #ddd;border-radius:10px;box-sizing:border-box;font-family:inherit;font-size:1rem}
        label{font-weight:bold;color:#4A7A5C}
        .btn{width:100%;padding:15px;border:none;border-radius:10px;cursor:pointer;color:white;font-size:1.2rem}
        .green{background:#96C8A4} .red{background:#d9534f} .blue{background:#73a0c0}
    </style>
</head>
<body>
    <div style="text-align:center;margin-bottom:20px">
        <h1>✈️ 管理我嘅島</h1>
        <a href="index.html" style="text-decoration:none;color:#73a0c0;font-weight:bold">← 返首頁</a>
    </div>
    <div class="box" id="content">檢查中...</div>

    <script>
        const API_URL = "https://api.ttctv-105.cc";
        const user = JSON.parse(localStorage.getItem('acnh_user'));
        if(!user) window.location.href="login.html";

        const content = document.getElementById('content');
        checkStatus();

        async function checkStatus() {
            try {
                const res = await fetch(`${API_URL}/my-status?email=${encodeURIComponent(user.email)}`);
                const json = await res.json();
                if(json.data) showClose(json.data); else showHost();
            } catch(e) { content.innerHTML = "連線失敗"; }
        }

        function showHost() {
            content.innerHTML = `
                <h3>登記開島</h3>
                <label>Dodo Code™</label>
                <input id="dodo" placeholder="5位 Code" maxlength="5">
                
                <label>島名</label>
                <input id="name" value="${user.username}的島">
                
                <label>同時上島人數限制 (最多8人)</label>
                <select id="maxUsers">
                    <option value="1">1人</option>
                    <option value="2">2人</option>
                    <option value="3">3人</option>
                    <option value="4" selected>4人 (推薦)</option>
                    <option value="5">5人</option>
                    <option value="6">6人</option>
                    <option value="7">7人</option>
                    <option value="8">8人</option>
                </select>

                <label>備註</label>
                <textarea id="note" placeholder="例如: 賣大頭菜 500！"></textarea>
                <button onclick="host()" class="btn green">確認開島</button>
            `;
        }

        function showClose(data) {
            content.innerHTML = `
                <h3 style="text-align:center;color:#4A7A5C">開放中...</h3>
                <p>島名: ${data.island_name}</p>
                <p>限制人數: ${data.max_visitors} 人</p>
                <p style="font-size:1.5rem;color:#73a0c0;font-weight:bold;text-align:center">${data.dodo_code}</p>
                <a href="island.html?host=${encodeURIComponent(user.email)}" class="btn blue" style="display:block;text-align:center;text-decoration:none;box-sizing:border-box;margin-bottom:10px">️ 檢視排隊 & 留言</a>
                <button onclick="closeIsland()" class="btn red">⚠️ 立即關島</button>
            `;
        }

        async function host() {
            const payload = {
                email: user.email, 
                islandName: document.getElementById('name').value,
                dodoCode: document.getElementById('dodo').value, 
                note: document.getElementById('note').value,
                maxVisitors: document.getElementById('maxUsers').value // 傳送人數限制
            };
            await fetch(`${API_URL}/host`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
            checkStatus();
        }

        async function closeIsland() {
            if(!confirm("確定關島？")) return;
            await fetch(`${API_URL}/close`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({email: user.email}) });
            checkStatus();
        }
    </script>
</body>
</html>