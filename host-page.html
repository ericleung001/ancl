<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†æˆ‘å˜…å³¶</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body{font-family:'Nunito',sans-serif;background:#F5F5E8;color:#8B5A2B;padding:20px;margin:0;}
        .container{max-width:600px;margin:0 auto;}
        .box{background:white;padding:30px;border-radius:20px;border:2px solid #96C8A4;box-shadow:0 4px 10px rgba(0,0,0,0.05);}
        h1{text-align:center; color:#4A7A5C;}
        label{font-weight:bold;color:#4A7A5C;display:block;margin-top:15px;}
        input,textarea,select{width:100%;padding:12px;margin-top:5px;border:2px solid #ddd;border-radius:10px;box-sizing:border-box;font-size:16px;font-family:inherit;}
        .btn{width:100%;padding:15px;border:none;border-radius:10px;cursor:pointer;color:white;font-size:1.2rem;margin-top:20px;}
        .green{background:#96C8A4} .red{background:#c0392b} .blue{background:#2980b9}
    </style>
</head>
<body>
    <div class="container">
        <h1>âœˆï¸ ç®¡ç†æˆ‘å˜…å³¶</h1>
        <div style="text-align:center;margin-bottom:20px">
            <a href="index.html" style="text-decoration:none;color:#73a0c0;font-weight:bold">â† è¿”é¦–é </a>
        </div>
        <div class="box" id="content">æª¢æŸ¥ä¸­...</div>
    </div>

    <script>
        const API_URL = "https://api.ttctv-105.cc";
        const user = JSON.parse(localStorage.getItem('acnh_user'));
        if(!user) window.location.href="login.html";

        const content = document.getElementById('content');
        checkStatus();

        async function checkStatus() {
            try {
                const res = await fetch(`${API_URL}/my-status?email=${encodeURIComponent(user.email)}`);
                const json = await res.json();
                if(json.data) showClose(json.data); else showHost();
            } catch(e) { content.innerHTML = "é€£ç·šå¤±æ•—"; }
        }

        function showHost() {
            content.innerHTML = `
                <h3 style="text-align:center;margin-top:0">ç™»è¨˜é–‹å³¶</h3>
                <label>Dodo Codeâ„¢</label>
                <input id="dodo" placeholder="5ä½ Code" maxlength="5">
                <label>å³¶å</label>
                <input id="name" value="${user.username}çš„å³¶">
                <label>åŒæ™‚ä¸Šå³¶äººæ•¸é™åˆ¶</label>
                <select id="maxUsers">
                    <option value="2">2äºº</option>
                    <option value="3">3äºº</option>
                    <option value="4" selected>4äºº (æ¨è–¦)</option>
                    <option value="5">5äºº</option>
                    <option value="6">6äºº</option>
                    <option value="7">7äºº</option>
                    <option value="8">8äºº</option>
                </select>
                <label>å‚™è¨»</label>
                <textarea id="note" placeholder="ä¾‹å¦‚: è³£å¤§é ­èœ 500ï¼" rows="3"></textarea>
                <button onclick="host()" class="btn green">ç¢ºèªé–‹å³¶</button>
            `;
        }

        function showClose(data) {
            content.innerHTML = `
                <h3 style="text-align:center;color:#4A7A5C;margin-top:0">é–‹æ”¾ä¸­...</h3>
                <p><strong>å³¶å:</strong> ${data.island_name}</p>
                <p><strong>é™åˆ¶:</strong> ${data.max_visitors} äºº</p>
                <div style="background:#f0f8ff;padding:15px;border-radius:10px;text-align:center;margin:15px 0;">
                    <span style="font-size:2rem;color:#73a0c0;font-weight:bold;letter-spacing:3px">${data.dodo_code}</span>
                </div>
                <a href="island.html?host=${encodeURIComponent(user.email)}" class="btn blue" style="display:block;text-align:center;text-decoration:none;box-sizing:border-box;margin-bottom:10px">ğŸ‘ï¸ æª¢è¦–æ’éšŠ & ç•™è¨€</a>
                <button onclick="closeIsland()" class="btn red">âš ï¸ ç«‹å³é—œå³¶</button>
            `;
        }

        async function host() {
            const payload = {
                email: user.email, islandName: document.getElementById('name').value,
                dodoCode: document.getElementById('dodo').value, note: document.getElementById('note').value,
                maxVisitors: document.getElementById('maxUsers').value
            };
            await fetch(`${API_URL}/host`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
            checkStatus();
        }

        async function closeIsland() {
            if(!confirm("ç¢ºå®šé—œå³¶ï¼Ÿæ’éšŠåŠç•™è¨€å°‡è¢«æ¸…ç©º")) return;
            await fetch(`${API_URL}/close`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({email: user.email}) });
            checkStatus();
        }
    </script>
</body>
</html>
